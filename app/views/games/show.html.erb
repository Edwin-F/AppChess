<script>
function init() {
  // define modal for pawn promotion
  var dialog = $('#pawn-promotion').dialog({
          autoOpen: false,
          width: 350,
          height: 300,
          modal: true,
          closeOnEscape: false,
          draggable: true,
          title: 'Pawn Promotion',
          buttons: {
              'Promote Pawn': function(){
                 promotePawn(href,yCoord, xCoord,color);
                 $( this ).dialog( "close" );
              },
              'Cancel': function () {
                  $('#pawn-promotion').dialog('close');
                  window.reload;
              }      
          }
        });
  
  function promotePawn(link,row,col,color) {
    //alert("promote "+ link +" "+ row+col+color+" to "+ $('input[name=radio]:checked', '#pawn-promotion').val());
    //for create a piece 
    $.ajax({
      type: "Post",
      url: "/pieces", //will look something like this /games/:id/pieces(.:format) similar to nomster//
      dataType: 'json',
      data: { piece: { 
              position_row: row, 
              position_column: col,//probably inputs for the function
              color: color,
              game_id: '<%= @game.id %>',
              type: $('input[name=radio]:checked', '#pawn-promotion').val()
              }
            },
      success: function(response){
        alert('this was a success');
        },
      error: function (request, status, error) {
          alert(request.responseText);
      }
    });
    //second ajax request to delete previous pawn piece
    $.ajax({
      type: "DELETE",
      url: link,
      succes: function(response){alert('This delete was a success')},
      error: function(request, status, error) {alert(request.responseText)}
    });
    window.location.reload();
  }

  /*open module when a pawn reaches end of board
  $( "#pawn-promote" ).button().on( "click", function() {
        dialog.dialog( "open" );
        //make sure to cancel reload here
    });*/

  turn = '<%= @game.turn %>';
  white = '<%= @game.white_player_id %>';
  black = '<%= @game.black_player_id %>';

  if (turn == white){
    $('#black a').draggable({disabled: true});
    var color = "white"
  }
  else {
    $('#white a').draggable({disabled: true});
    var color = "black"
  };

  $('a').draggable({
    containment: 'table',
    scroll: false,
    revert: false,
    start: function( event, ui) {
      $.ajaxSetup({ cache: false });
      href = this.href;
      pieceType = $(this).parent().data('piece-type');
     //pieceType = this.parentElement.dataset.pieceType;
     //.data('piece-type');
     console.log(pieceType);      
    },
    drag: function( event, ui ) {
      // x is going left or right (position_col)
      xCoord = $('.ui-droppable-hover').data('x-position');
      // y is going up or down (position_row)
      yCoord = $('.ui-droppable-hover').data('y-position');
    },
    stop: function( event,ui ) {
      
      $.ajax({
        type: "PUT",
        url: href,
        data: {
          x_coord: xCoord, 
          y_coord: yCoord
        },
        success: function (response) {
          alert("Valid Move!");
          // check for pawn promotion event
          if(pieceType == 'Pawn' && ((yCoord == 0 && color == "black" ) || (yCoord == 7 && color == "white"))) {         
            dialog.dialog( "open" );
          } else {
            window.location.reload();
          }
        },
        error: function (request, status, error) {
          alert(request.responseText);
          window.location.reload();
        }
      });
        
    }
  });

  $('tr td').droppable({
    greedy: true
  });
};

$( init );
$(document).ajaxStop(function(){
  //window.location.reload();
});

</script>

<!-- Button trigger modal -->
 

 <div class = "boom-box col-10 offset-1"
  <br>
  <h1> WELCOME TO YOUR GAME MWAHAHAHAH </h1>
  <br>
  <% if @game.check?.first %>
    <div class= "alert col-8 offset-2">
      <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span> 
        <h1> <%= @game.check?.first %> is in check! </h1>
    </div>
  <% end %> 

  <% if @game.turn == @game.white_player_id %>
  <h1>Current player turn: white</h1>
  <% else %>
  <h1>Current player turn: black</h1>
  <% end %>
</div>
<table>
<%(0..7).reverse_each do |position_row|%>
  <tr class= 'position_row'>
    <%(0..7).each do |position_column|%>
      <td class= 'position_column' data-x-position='<%=position_column%>' data-y-position='<%=position_row%>'>
        <div class='chess_pieces'>
          <%piece = @game.data_method[position_column][position_row]%>
          <div id='<%= piece.color if piece.present?%>' data-piece-type='<%= piece.type if piece.present?%>'>
          <%=link_to piece.symbol.html_safe, piece_path(piece), onclick: 'return false' if piece.present?%>
          </div>
        </div>
      </td>
    <% end %>
  </tr>
<% end %>
<table>
<div class="col-12 text-center">
  <% if @game.black_player_id == nil && @game.white_player_id != current_user.id %>
    <%= link_to 'Join', game_path, method: :put, class: 'btn btn-primary btn-large' %>
  <% end %>
</div>

<div id="pawn-promotion">
    <form>
    <input type="radio" name="radio" value="Knight"> Knight <br>
    <input type="radio" name="radio" value="Rook"> Rook <br>
    <input type="radio" name="radio" value="Bishop"> Bishop <br>
    <input type="radio" name="radio" value="Queen"> Queen <br>
    </form>
</div>
<!--<button id="pawn-promote">Open Modal</button> <br>->
